<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.5.3" />
<title>EDA_miner_public.apps.analyze.Model_Builder API documentation</title>
<meta name="description" content="This module will be used to graphically create models.
RapidMiner, Weka, Orange, etc, ain&#39;t got sh!t on us :) â€¦" />
<link href='https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css' rel='stylesheet'>
<link href='https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/8.0.0/sanitize.min.css' rel='stylesheet'>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" rel="stylesheet">
<style>.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{font-weight:bold}#index h4 + ul{margin-bottom:.6em}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase;cursor:pointer}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}.admonition{padding:.1em .5em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>EDA_miner_public.apps.analyze.Model_Builder</code></h1>
</header>
<section id="section-intro">
<p>This module will be used to graphically create models.
RapidMiner, Weka, Orange, etc, ain't got sh!t on us :)</p>
<p>You should probably not write code here.</p>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">&#34;&#34;&#34;
    This module will be used to graphically create models.
    RapidMiner, Weka, Orange, etc, ain&#39;t got sh!t on us :)

    You should probably not write code here.
&#34;&#34;&#34;

from dash.dependencies import Input, Output, State
import dash_core_components as dcc
import dash_html_components as html
from dash.exceptions import PreventUpdate

import dash_cytoscape as cyto
import dash_bootstrap_components as dbc

from server import app
from utils import r, create_dropdown
from styles import cyto_stylesheet
from apps.analyze.models import pipeline_creator
from apps.analyze.models.graph_structures import Graph, GraphUtils, orders
from apps.analyze.models.graph_structures import node_options, ml_options

import dill


# TODO: Add divider for categories with huge lists
items = [
    [dbc.DropdownMenuItem(model[&#34;label&#34;], id=f&#34;add_{model[&#39;node_type&#39;]}&#34;,
                          n_clicks_timestamp=0)
     for model in ml_options
     if model[&#34;parent&#34;] == category]
    for category in orders
]

# Layout definition for the initial setup
default_steps = [
    (0, &#34;input_file&#34;, &#34;Input data&#34;),
    (1, &#34;data_cleaner&#34;, &#34;Data cleaning&#34;),
    (2, &#34;stdsc&#34;, &#34;Standardization&#34;),
    (3, &#34;pca&#34;, &#34;Principal Components Analysis&#34;),
    (4, &#34;linr&#34;, &#34;Linear Regression&#34;),
]

initial_graph = GraphUtils(default_steps).render_graph()


Model_Builder_Layout = html.Div([
    cyto.Cytoscape(
        id=&#39;cytoscape-graph&#39;,
        layout={&#39;name&#39;: &#34;preset&#34;},
        style={&#34;width&#34;: &#34;98%&#34;, &#34;height&#34;: &#34;600px&#34;},
        elements=initial_graph,
        stylesheet=cyto_stylesheet,
    ),


    dbc.Modal([
        dbc.ModalHeader(&#34;Pipelines exported:&#34;),
        dbc.ModalBody(&#34;No pipeline exported.&#34;, id=&#34;model_specs&#34;),
        dbc.ModalFooter(
            dbc.Button(&#34;Close&#34;, id=&#34;close&#34;, className=&#34;ml-auto&#34;)
        ),
    ], id=&#34;modal&#34;),

])


SideBar_modelBuilder = [

    # Convert model
    html.Div([
        html.Button(&#34;Convert to model&#34;,
                    id=&#34;convert&#34;),
    ], id=&#34;export_pipe_submenu&#34;),

    # Remove nodes
    html.Div([
        html.Button(&#34;Remove a node&#34;, id=&#34;remove_node&#34;,
                    n_clicks_timestamp=0, ),
        dcc.Dropdown(options=[{&#34;value&#34;: elem[&#34;data&#34;][&#34;id&#34;],
                               &#34;label&#34;: elem[&#34;data&#34;][&#34;label&#34;]}
                              for elem in initial_graph[:-4]
                              if &#34;parent&#34; in elem[&#34;data&#34;]],
                     id=&#34;delete_options&#34;),
    ], id=&#34;remove_node_submenu&#34;),

    # Connect selected nodes
    html.Div([
        html.Button(&#34;Connect selected nodes&#34;,
                    n_clicks_timestamp=0,
                    id=&#34;connect_selected_nodes&#34;),
    ], id=&#34;connect_nodes_submenu&#34;),


    # Add nodes (collapsible)
    html.Div([
        html.Button([
            html.Span(&#39;Add node&#39;),
            html.I(&#34;&#34;, className=&#34;fa fa-caret-down&#34;),
        ], id=&#39;button_collapse_add_node&#39;, n_clicks=0),
        # Stuff inside the collapsible
        html.Div(id=&#39;sidebar_collapsible_button_add_node&#39;, children=[
            dbc.DropdownMenu(
                label=f&#34;Category: {category}&#34;, children=item,
                className=&#34;mb-3&#34;
            ) for (category, item) in zip(orders, items)
        ]),
    ], id=&#34;add_nodes_submenu&#34;),


    # Modify nodes (collapsible)
    html.Div([
        html.Button([
            html.Span(&#39;Node options&#39;),
            html.I(&#34;&#34;, className=&#34;fa fa-caret-down&#34;),
        ], id=&#39;button_collapse_modify_node&#39;, n_clicks=0),
        # Stuff inside the collapsible
        html.Div(id=&#39;sidebar_collapsible_button_modify_node&#39;, children=[
            html.Div(id=&#34;inspector&#34;, children=[
                html.Div([
                    *create_dropdown(&#34;Options&#34;, [
                        {&#34;label&#34;: &#34;No node selected&#34;, &#34;value&#34;: &#34;none&#34;}
                    ], id=&#34;modify_option_dropdown&#34;),
                    dcc.RadioItems(options=[
                        {&#34;label&#34;: &#34;No node selected&#34;, &#34;value&#34;: &#34;none&#34;}
                    ], id=&#34;modify_node_params&#34;,
                       labelStyle={
                           &#39;display&#39;: &#39;inline-block&#39;,
                           &#39;margin&#39;: &#39;5px&#39;
                       }
                    )
                ])
            ]),


            html.Button(&#34;Update node&#34;, id=&#34;modify_node&#34;, n_clicks=0,
                        n_clicks_timestamp=0),
            dbc.Modal([
                dbc.ModalHeader(&#34;Model update:&#34;),
                dbc.ModalBody(&#34;Model parameters were successfully updated.&#34;),
                dbc.ModalFooter(
                    dbc.Button(&#34;Close&#34;, id=&#34;close2&#34;, className=&#34;ml-auto&#34;)
                ),
            ], id=&#34;modal2&#34;),

        ]),
    ], id=&#34;modify_nodes_submenu&#34;),


]


# TODO: These two callbacks can probably be condensed in a loop or combined
# When the sidebar button is clicked, collapse the div
@app.callback(Output(&#39;sidebar_collapsible_button_add_node&#39;, &#39;style&#39;),
              [Input(&#39;button_collapse_add_node&#39;, &#39;n_clicks&#39;)],)
def button_toggle(n_clicks):
    if n_clicks is not None and n_clicks % 2 == 1:
        # Start with the menu open
        return {&#39;display&#39;: &#39;none&#39;}
    else:
        return {&#39;display&#39;: &#39;block&#39;}

# Same as above
@app.callback(Output(&#39;sidebar_collapsible_button_modify_node&#39;, &#39;style&#39;),
              [Input(&#39;button_collapse_modify_node&#39;, &#39;n_clicks&#39;)])
def button_toggle(n_clicks):
    if n_clicks is not None and n_clicks % 2 == 1:
        # Start with the menu open
        return {&#39;display&#39;: &#39;none&#39;}
    else:
        return {&#39;display&#39;: &#39;block&#39;}


@app.callback(Output(&#34;cytoscape-graph&#34;, &#34;elements&#34;),
              [Input(&#34;remove_node&#34;, &#34;n_clicks_timestamp&#34;),
               Input(&#34;connect_selected_nodes&#34;, &#34;n_clicks_timestamp&#34;),
               Input(&#34;modify_node&#34;, &#34;n_clicks_timestamp&#34;)]+[
                  Input(f&#34;add_{node_options[model][&#39;node_type&#39;]}&#34;,
                        &#34;n_clicks_timestamp&#34;)
                  for model in node_options
              ],
              [State(&#34;cytoscape-graph&#34;, &#34;elements&#34;),
               State(&#34;delete_options&#34;, &#34;value&#34;),
               State(&#34;cytoscape-graph&#34;, &#34;selectedNodeData&#34;),
               State(&#34;modify_option_dropdown&#34;, &#34;value&#34;),
               State(&#34;modify_node_params&#34;, &#34;value&#34;),
               State(&#34;cytoscape-graph&#34;, &#34;tapNodeData&#34;)])
def modify_graph(remove_clicked_time, connect_selected_time,
                 modify_node_time, *add_nodes):

    # This is necessary since Python cannot accept *args in the middle
    # of the function parameter list. The tapped node is used only for
    # altering parameters on the last-clicked node, while the selected
    # is used for connecting nodes. The modify_node_attribute refers to
    # the dropdown (sklearn kwarg) and modify_node_params is the value
    (elems, to_be_deleted, selected, modify_node_attribute,
            modify_node_params, tapped) = add_nodes[-6:]

    add_nodes = add_nodes[:-6]

    if all(x is None for x in [remove_clicked_time, connect_selected_time,
                               modify_node_time, *add_nodes]):
        if elems is not None:
            return elems
        else:
            return []

    G = Graph(elems)

    # Create list of tuples, e.g.: (time_clicked, add_xgb)
    add_node_list = [(add_node, f&#34;add_{model}&#34;)
                     for (add_node, model) in zip(add_nodes, node_options)]

    # Sort buttons based on clicked time (most recent first)
    buttons_and_clicks = sorted([
        (remove_clicked_time, &#34;remove&#34;),
        (connect_selected_time, &#34;connect&#34;),
        (modify_node_time, &#34;modify&#34;)
    ] + add_node_list, reverse=True)

    # Graph operations
    if buttons_and_clicks[0][1] == &#34;remove&#34;:
        G.node_collection.remove_node(to_be_deleted)

    elif buttons_and_clicks[0][1] == &#34;connect&#34;:
        G.edge_collection.add_edges(selected)

    elif buttons_and_clicks[0][1].startswith(&#34;add_&#34;):
        # e.g.: (time_clicked, add_xgb) --&gt; xgb
        G.node_collection.add_node(buttons_and_clicks[0][1][4:])

    elif buttons_and_clicks[0][1] == &#34;modify&#34;:
        if tapped is not None:
            for node in G.node_collection.nodes:
                # iterate over all the nodes to find the appropriate one
                # TODO: The fact that is is necessary means that `Graph`
                #       should implement a __get__ method (or w/e it is)
                if node.id == tapped[&#34;id&#34;]:
                    node.options[&#34;data&#34;][&#34;func_params&#34;].update({modify_node_attribute: modify_node_params})

    return G.render_graph()


@app.callback(Output(&#34;inspector&#34;, &#34;children&#34;),
              [Input(&#34;cytoscape-graph&#34;, &#34;tapNodeData&#34;)],
              [State(&#34;user_id&#34;, &#34;children&#34;)])
def inspect_node(selected, user_id):


    if selected is None or &#34;parent&#34; not in selected:
        # No need to show info for parent nodes as
        # they are there just for show
        raise PreventUpdate()

    if len(selected):
        func = node_options[selected[&#34;node_type&#34;]][&#34;func&#34;]
        arguments = list(func.modifiable_params.keys())

    return [
        html.Div([
            *create_dropdown(&#34;Options&#34;, [
                {&#34;label&#34;: arg, &#34;value&#34;: arg}
                for arg in arguments
            ], id=&#34;modify_option_dropdown&#34;),
            dcc.RadioItems(options=[
                {&#34;label&#34;: &#34;No node selected&#34;, &#34;value&#34;: &#34;none&#34;}
            ], id=&#34;modify_node_params&#34;,
               labelStyle={
                   &#39;display&#39;: &#39;inline-block&#39;,
                   &#39;margin&#39;: &#39;5px&#39;
               })
        ]),
    ]


@app.callback(
    Output(&#34;modal2&#34;, &#34;is_open&#34;),
    [Input(&#34;modify_node&#34;, &#34;n_clicks&#34;),
     Input(&#34;close2&#34;, &#34;n_clicks&#34;)],
    [State(&#34;modal2&#34;, &#34;is_open&#34;)],
)
def toggle_modal(n1, n2, is_open):
    if n1 or n2:
        return not is_open
    return is_open


def stringify(val):
    # Since some values are either bool or none
    # we need to explicitly convert them
    if val is None:
        return &#34;None&#34;
    elif val is True:
        return &#34;True&#34;
    elif val is False:
        return &#34;False&#34;
    else:
        return str(val)

@app.callback(Output(&#34;modify_node_params&#34;, &#34;options&#34;),
              [Input(&#34;modify_option_dropdown&#34;, &#34;value&#34;)],
              [State(&#34;cytoscape-graph&#34;, &#34;tapNodeData&#34;)])
def update_radio_buttons_modify_params(value, selected):

    if selected is None or value is None:
        return [
            {&#34;label&#34;: &#34;No node selected&#34;, &#34;value&#34;: &#34;none&#34;}
        ]

    if len(selected):
        func = node_options[selected[&#34;node_type&#34;]][&#34;func&#34;]

    return [
        {&#34;label&#34;: stringify(val), &#34;value&#34;: val}
        for val in func.modifiable_params[value]
    ]


@app.callback(Output(&#34;delete_options&#34;, &#34;options&#34;),
              [Input(&#34;cytoscape-graph&#34;, &#34;elements&#34;)],
              [State(&#34;user_id&#34;, &#34;children&#34;)])
def inspect_node(elements, user_id):


    return [{
        &#34;value&#34;: elem[&#34;data&#34;][&#34;id&#34;],
        &#34;label&#34;: elem[&#34;data&#34;][&#34;label&#34;]
        } for elem in elements if (elem[&#34;data&#34;].get(&#34;source&#34;) is None) and
                                  (&#34;parent&#34; in elem[&#34;data&#34;])]


@app.callback([Output(&#34;modal&#34;, &#34;is_open&#34;),
               Output(&#34;model_specs&#34;, &#34;children&#34;)],
              [Input(&#34;convert&#34;, &#34;n_clicks&#34;),
               Input(&#34;close&#34;, &#34;n_clicks&#34;)],
              [State(&#34;cytoscape-graph&#34;, &#34;elements&#34;),
               State(&#34;cytoscape-graph&#34;, &#34;stylesheet&#34;),
               State(&#34;user_id&#34;, &#34;children&#34;),
               State(&#34;modal&#34;, &#34;is_open&#34;)])
def convert_model(n_clicks, close, elements, layout, user_id, is_open):

    if user_id.startswith(&#34;python_generated_ssid&#34;):
        # Trim id
        user_id = user_id.split(&#34;-&#34;)[-1]


    if n_clicks is None:
        return [False, [html.H5(&#34;No specs defined yet&#34;)]]

    else:
        # Keep elements that are either edges (have a source)
        # or elements that have a parent (nodes, not groups)
        elements = [elem for elem in elements if ((&#34;source&#34; in elem[&#34;data&#34;]) or
                                                  (&#34;parent&#34; in elem[&#34;data&#34;]))]

        pipelines, classifiers = pipeline_creator.create_pipelines(elements,
                                                                   node_options)

        # Save pipelines to Redis (to be used in other modules)
        for pipe, clf in zip(pipelines, classifiers):
            r.set(f&#34;{user_id}_pipeline_{clf}&#34;, dill.dumps(pipe))

        # TODO: Make this a modal
        #       https://dash-bootstrap-components.opensource.faculty.ai/l/components/modal
        return [not is_open, [html.P(f&#34;{i+1}) {str(pipeline)}&#34;)
                for (i, pipeline) in enumerate(pipelines)]]</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="EDA_miner_public.apps.analyze.Model_Builder.stringify"><code class="name flex">
<span>def <span class="ident">stringify</span></span>(<span>val)</span>
</code></dt>
<dd>
<section class="desc"></section>
<details class="source">
<summary>Source code</summary>
<pre><code class="python">def stringify(val):
    # Since some values are either bool or none
    # we need to explicitly convert them
    if val is None:
        return &#34;None&#34;
    elif val is True:
        return &#34;True&#34;
    elif val is False:
        return &#34;False&#34;
    else:
        return str(val)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="EDA_miner_public.apps.analyze" href="index.html">EDA_miner_public.apps.analyze</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="EDA_miner_public.apps.analyze.Model_Builder.stringify" href="#EDA_miner_public.apps.analyze.Model_Builder.stringify">stringify</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc"><cite>pdoc</cite> 0.5.3</a>.</p>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
</body>
</html>